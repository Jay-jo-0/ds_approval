<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>최종 결과물 선택 및 수정</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background-color: #f5f5f5; }
    .section { margin-bottom: 20px; padding: 0 10px; }
    h2 { font-size: 1.2em; margin-bottom: 5px; }
    p { font-size: 0.9em; margin-bottom: 5px; }
    select, input, textarea, button {
      font-size: 1em; padding: 8px; margin-top: 5px;
      display: block; width: 100%; box-sizing: border-box;
    }
    textarea { resize: vertical; }
    .worker-row { display: flex; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
    .worker-row select { flex: 1; min-width: 0; font-size: 0.9em; border: 1px solid #ccc; background-color: white; }
    .remove-button { margin-left: 5px; background-color: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; padding: 4px 8px; min-width: 20px; }
    .summary-row { display: flex; align-items: center; margin-bottom: 5px; }
    .summary-row textarea { flex: 1; font-size: 0.9em; resize: vertical; min-height: 60px; }
    .char-counter { margin-left: 8px; font-size: 0.8em; white-space: nowrap; }
    .mail-receiver-item { margin-bottom: 5px; font-size: 0.9em; }
    .mail-receiver-item label { display: flex; align-items: center; }
    .mail-receiver-item input[type="checkbox"] { margin-right: 5px; width: auto; }
    @media (max-width: 400px) {
      h2 { font-size: 1.1em; }
      p, .mail-receiver-item { font-size: 0.8em; }
      select, input, textarea, button { font-size: 0.9em; padding: 6px; }
      .remove-button { font-size: 0.75em; padding: 3px 6px; }
      .char-counter { font-size: 0.75em; }
    }
  </style>
</head>
<body>
  <!-- 보고서 제목 섹션 -->
  <div class="section">
    <h2>보고서 제목</h2>
    <p>보고서 제목을 입력하세요.</p>
    <textarea id="reportTitle" placeholder="보고서 제목"></textarea>
  </div>
  
  <!-- 카테고리 선택 섹션 -->
  <div class="section">
    <h2>카테고리 선택</h2>
    <p>원하는 카테고리를 선택하세요.</p>
    <select id="categorySelect"></select>
  </div>
  
  <!-- 대표 애널리스트 선택 섹션 -->
  <div class="section">
    <h2>대표 애널리스트 선택</h2>
    <p>대표 애널리스트를 선택하세요.</p>
    <select id="analystSelect"></select>
  </div>
  
  <!-- 실제 작업자 선택 섹션 -->
  <div class="section">
    <h2>실제 작업자 선택</h2>
    <p>실제 작업자는 쉼표로 구분된 "부서\n이름" 문자열입니다. "+" 버튼으로 추가, "-" 버튼으로 제거할 수 있습니다.</p>
    <div id="workerContainer"></div>
    <button id="addWorkerButton" type="button">+</button>
  </div>
  
  <!-- 캡쳐 페이지 섹션 -->
  <div class="section">
    <h2>캡쳐 페이지</h2>
    <p>캡쳐 페이지 번호를 입력하세요.</p>
    <input type="number" id="capturePage" value="1" min="1">
  </div>
  
  <!-- 요약 수정 섹션 -->
  <div class="section">
    <h2>요약 수정</h2>
    <p>요약은 세 줄로 구성됩니다. (각 줄 최대 60자)</p>
    <div id="summaryContainer"></div>
  </div>
  
  <!-- 모닝미팅 포함 여부 섹션 -->
  <div class="section">
    <h2>모닝미팅 포함 여부</h2>
    <p>모닝미팅 포함 여부를 선택하세요.</p>
    <select id="morningSelect">
      <option value="True">True</option>
      <option value="False">False</option>
    </select>
  </div>
  
  <!-- 메일 발신 여부 섹션 -->
  <div class="section">
    <h2>메일 발신 여부</h2>
    <p>메일 발신 여부를 선택하세요.</p>
    <select id="mailingSelect">
      <option value="True">True</option>
      <option value="False">False</option>
    </select>
  </div>
  
  <!-- 메일 수신자 섹션 -->
  <div class="section" id="mailReceiverSection">
    <h2>메일 수신자 선택</h2>
    <p>메일 수신자를 선택하세요.</p>
    <div id="mailReceiverContainer"></div>
  </div>
  
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
  
    // URL 파라미터로부터 기본값 읽기 (생략 - 이전 코드와 동일) ...
    const defaultReportTitle = getQueryParam("report_title") || "기본 보고서 제목";
    const defaultCatNum = parseInt(getQueryParam("cat_num")) || null;
    const defaultRep = getQueryParam("rep") || "";
    const defaultWorkersParam = getQueryParam("workers") || "";
    const defaultWorkers = defaultWorkersParam
      ? defaultWorkersParam.split(",").map(s => s.trim()).filter(s => s !== "")
      : ["FICC리서치부\n조재운", "장기전략리서치부\n공동락"];
    const defaultCapturePage = getQueryParam("capture_page") || "1";
    const defaultSummaryParam = getQueryParam("summary") ||
      "예시 요약 줄 1\n예시 요약 줄 2\n예시 요약 줄 3";
    const defaultSummaryLines = defaultSummaryParam.split("\n").map(line => line.trim());
    const defaultMorning = getQueryParam("morning") || "True";
    const defaultMailingTF = getQueryParam("mailingTF") || "True";
    const defaultMailReceiversParam = getQueryParam("mail_receivers") || "";
    const defaultMailReceivers = defaultMailReceiversParam
      ? defaultMailReceiversParam.split("\n").map(s => s.trim()).filter(s => s !== "")
      : ["기관공통 수신자", "기타공통 수신자", "리서치센터 수신자"];
  
    // 예제용 데이터 (실제 값과 동일) (생략 - 이전 코드와 동일) ...
    const categories = [
      {dept: "기업리서치부", subcategory: "기업/산업뉴스", text: "산업분석 (1)", number: 1},
      {dept: "기업리서치부", subcategory: "기업/산업뉴스", text: "산업분석 (2)", number: 2},
      {dept: "기업리서치부", subcategory: "기업/산업뉴스", text: "산업분석 (3)", number: 3},
      {dept: "기업리서치부", subcategory: "기업/산업뉴스", text: "기업분석 (4)", number: 4},
      {dept: "기업리서치부", subcategory: "기업/산업뉴스", text: "해외기업 투자분석 (5)", number: 5},
      {dept: "기업리서치부", subcategory: "기업/산업뉴스", text: "상장예정기업 (6)", number: 6},
      {dept: "기업리서치부", subcategory: "기업/산업뉴스", text: "기업뉴스 (7)", number: 7},
      {dept: "기업리서치부", subcategory: "기업/산업뉴스", text: "Weekly (9)", number: 9},
      {dept: "기업리서치부", subcategory: "Morning Meeting Brief", text: "Morning Meeting Brief (13)", number: 13},
      {dept: "마켓전략실", subcategory: "Daishin's View", text: "Daishin's View (19)", number: 19},
      {dept: "마켓전략실", subcategory: "Macro 전략", text: "경제전망 (21)", number: 21},
      {dept: "마켓전략실", subcategory: "Macro 전략", text: "환율전망 (22)", number: 22},
      {dept: "마켓전략실", subcategory: "Macro 전략", text: "채권/크레딧 (23)", number: 23},
      {dept: "마켓전략실", subcategory: "Macro 전략", text: "자산배분 (24)", number: 24},
      {dept: "마켓전략실", subcategory: "Macro 전략", text: "이슈분석 (25)", number: 25},
      {dept: "마켓전략실", subcategory: "국내 투자전략", text: "시장전략 (27)", number: 27},
      {dept: "마켓전략실", subcategory: "국내 투자전략", text: "퀀트분석 (28)", number: 28},
      {dept: "마켓전략실", subcategory: "국내 투자전략", text: "이슈분석 (30)", number: 30},
      {dept: "마켓전략실", subcategory: "글로벌 투자전략", text: "시장전략 (32)", number: 32},
      {dept: "마켓전략실", subcategory: "글로벌 투자전략", text: "원자재 (33)", number: 33},
      {dept: "마켓전략실", subcategory: "글로벌 투자전략", text: "부동산 (34)", number: 34},
      {dept: "마켓전략실", subcategory: "글로벌 투자전략", text: "Global ETF (35)", number: 35},
      {dept: "마켓전략실", subcategory: "글로벌 투자전략", text: "이슈분석 (39)", number: 39}
    ];
  
    const dep_n_name = {
      "기업리서치부": [
        "권용수", "김귀연", "김수아", "김유진", "김지혜", "김회재",
        "박강호", "박혜진", "서지원", "신석환", "양지환", "오지현",
        "왕필환", "위정원", "유정현", "이소연", "이지니", "이지윤",
        "이지은", "이채리", "이태환", "이희영", "임수진", "정다영",
        "정한솔", "홍성원"
      ],
      "FICC리서치부": [
        "박초화", "박현정", "서영재", "이경민", "이경연", "이예지",
        "이주원", "이하연", "정해창", "조승빈", "조재운", "최진영", "하원준"
      ],
      "장기전략리서치부": [
        "공동락", "김다은", "나미선", "문건우", "문남중", "박세라",
        "박장욱", "배상영", "이혜진", "한송협", "허민호"
      ]
    };
  
    const mail_factor = {
      '기관공통 수신자': 'cb_client',
      '기업 수신자': 'cb_corporate',
      '기타공통 수신자': 'cb_etc',
      '내 인물 수신자': 'cb_my',
      '대신직원 수신자': 'cb_daishin',
      '리서치센터 수신자': 'cb_daishinReserach',
      '[개별자료]산업 및 기업': 'cb_industryNcompany',
      '[개별자료]투자전략': 'cb_investmentStrategy',
      '[개별자료] MMB(투자전략 자료 or MMB 단독 자료일 경우 선택': 'cb_MMB'
    };
      // 각 입력 필드에 기본값 채우기 (생략 - 이전 코드와 동일) ...
    document.getElementById("reportTitle").value = defaultReportTitle;
  
    const categorySelect = document.getElementById("categorySelect");
    categories.forEach(function(item) {
      const option = document.createElement("option");
      option.value = item.number;
      option.text = `${item.dept} - ${item.subcategory}: ${item.text}`;
      categorySelect.appendChild(option);
    });
    if (defaultCatNum !== null) {
      categorySelect.value = defaultCatNum;
    }
  
    const analystSelect = document.getElementById("analystSelect");
    for (const dept in dep_n_name) {
      const optgroup = document.createElement("optgroup");
      optgroup.label = dept;
      dep_n_name[dept].forEach(function(name) {
        const option = document.createElement("option");
        option.value = `${dept}\n${name}`;
        option.text = name;
        optgroup.appendChild(option);
      });
      analystSelect.appendChild(optgroup);
    }
    if (defaultRep !== "") {
      analystSelect.value = defaultRep;
    }
  
    const workerContainer = document.getElementById("workerContainer");
    function addWorkerSelect(value) {
      const row = document.createElement("div");
      row.className = "worker-row";
  
      const select = document.createElement("select");
      select.className = "worker-select";
      for (const dept in dep_n_name) {
        const optgroup = document.createElement("optgroup");
        optgroup.label = dept;
        dep_n_name[dept].forEach(function(name) {
          const option = document.createElement("option");
          option.value = `${dept}\n${name}`;
          option.text = name;
          optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
      }
      if (value) {
        select.value = value;
      }
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "remove-button";
      removeBtn.textContent = "-";
      removeBtn.addEventListener("click", function() {
        workerContainer.removeChild(row);
      });
      row.appendChild(select);
      row.appendChild(removeBtn);
      workerContainer.appendChild(row);
    }
    if (defaultWorkers.length > 0) {
      defaultWorkers.forEach(function(worker) {
        addWorkerSelect(worker);
      });
    } else {
      addWorkerSelect("");
    }
    document.getElementById("addWorkerButton").addEventListener("click", function() {
      addWorkerSelect("");
    });
  
    document.getElementById("capturePage").value = defaultCapturePage;
  
    const summaryContainer = document.getElementById("summaryContainer");
    defaultSummaryLines.forEach(function(line, index) {
      const wrapper = document.createElement("div");
      wrapper.className = "summary-row";
      const textarea = document.createElement("textarea");
      textarea.className = "summary-line";
      textarea.maxLength = 60;
      textarea.value = line;
      textarea.placeholder = `요약 ${index + 1}번째 줄 (최대 60자)`;
      const counter = document.createElement("span");
      counter.className = "char-counter";
      function updateCounter() {
        const len = textarea.value.length;
        counter.textContent = `${len}/60`;
      }
      updateCounter();
      textarea.addEventListener("input", updateCounter);
      wrapper.appendChild(textarea);
      wrapper.appendChild(counter);
      summaryContainer.appendChild(wrapper);
    });
  
    document.getElementById("morningSelect").value = defaultMorning;
    document.getElementById("mailingSelect").value = defaultMailingTF;
  
    const mailReceiverContainer = document.getElementById("mailReceiverContainer");
    function createMailReceiverCheckbox(label, defaultChecked) {
      const container = document.createElement("div");
      container.className = "mail-receiver-item";
      const labelElem = document.createElement("label");
      labelElem.htmlFor = mail_factor[label];
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = mail_factor[label];
      checkbox.value = label;
      if (defaultChecked) checkbox.checked = true;
      labelElem.appendChild(checkbox);
      labelElem.appendChild(document.createTextNode(label));
      container.appendChild(labelElem);
      mailReceiverContainer.appendChild(container);
    }
    for (const key in mail_factor) {
      const isDefault = defaultMailReceivers.includes(key);
      createMailReceiverCheckbox(key, isDefault);
    }
    function updateMailReceiverVisibility() {
      if (document.getElementById("mailingSelect").value === "True") {
        document.getElementById("mailReceiverSection").style.display = "block";
      } else {
        document.getElementById("mailReceiverSection").style.display = "none";
      }
    }
    document.getElementById("mailingSelect").addEventListener("change", updateMailReceiverVisibility);
    updateMailReceiverVisibility();
  
  
    // 봇 토큰과 채팅 ID (실제 값으로 바꿔야 함!)
    const botToken = 'YOUR_BOT_TOKEN';
    const chatId = 'TARGET_CHAT_ID';
  
  
    // 텔레그램으로 메시지 보내는 함수
    function sendMessage(chatId, text) {
      const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
  
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          chat_id: chatId,
          text: text,
          parse_mode: 'Markdown', // 서식 지정을 위해 Markdown 사용
        }),
      })
      .then(response => response.json())
      .then(data => {
        console.log('Success:', data);
        if (data.ok) {
            Telegram.WebApp.close(); // 성공 시 웹앱 닫기
        } else {
            // 텔레그램 API 에러 처리
            alert(`메시지 전송 실패: ${data.description}`);
        }
      })
      .catch((error) => {
        console.error('Error:', error);
        alert('메시지 전송 중 오류 발생'); // 사용자에게 오류 알림
      });
    }
  
  
    // 데이터를 포맷팅하는 함수
    function formatData(data) {
        let workers = data.workers.map(worker => {
          const [dept, name] = worker.split('\n');
          return `  - *부서:* ${dept}, *이름:* ${name}`;
        }).join('\n');
  
        let receivers = data.mail_receivers.join(', ');
  
        let formattedText = `
  *보고서 제목:* ${data.report_title}
  *카테고리 번호:* ${data.cat_num}
  *대표 애널리스트:* ${data.rep.replace('\n', ' - ')}
  *작업자:*
  ${workers}
  *캡쳐 페이지:* ${data.capture_page}
  *요약:*
  ${data.summary}
  *모닝미팅 포함 여부:* ${data.morning}
  *메일 발신 여부:* ${data.mailingTF}
  *메일 수신자:* ${receivers}
  `;
      return formattedText;
    }
  
  
  
    // 공식 예제처럼 Telegram.WebApp.MainButton 사용: 버튼 텍스트 설정 및 클릭 이벤트 등록
    Telegram.WebApp.MainButton.setText("전송");
    Telegram.WebApp.MainButton.show();
    Telegram.WebApp.MainButton.onClick(function () {
      const result = {
          report_title: document.getElementById("reportTitle").value,
          cat_num: document.getElementById("categorySelect").value,
          rep: document.getElementById("analystSelect").value,
          workers: Array.from(document.querySelectorAll(".worker-select"))
                        .map(select => select.value)
                        .filter(val => val.trim() !== ""),
          capture_page: document.getElementById("capturePage").value,
          summary: Array.from(document.querySelectorAll(".summary-line"))
                        .map(textarea => textarea.value.trim())
                        .join("\n"),
          morning: document.getElementById("morningSelect").value,
          mailingTF: document.getElementById("mailingSelect").value,
          mail_receivers: Array.from(document.querySelectorAll("#mailReceiverContainer input[type='checkbox']"))
                              .filter(cb => cb.checked)
                              .map(cb => cb.value)
      };
  
        const formattedMessage = formatData(result);
        // Telegram.WebApp.sendData(JSON.stringify(result));  // sendData 주석 처리
        sendMessage(chatId, formattedMessage); // 텔레그램 봇 API로 전송
  
      // Telegram.WebApp.close();  // sendMessage 에서 처리.
    });
  </script>
</body>
</html>
